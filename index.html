<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Available Dresses</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f9f9f9; font-size:12px; padding:10px; }
h2 { text-align:center; font-size:16px; margin:0 0 10px; }
.search-container { display:flex; justify-content:center; gap:6px; margin-bottom:8px; flex-wrap:wrap; }
input { padding:4px; width:90px; font-size:11px; }
button { padding:4px 10px; font-size:11px; cursor:pointer; }
table { width:100%; border-collapse:collapse; background:#fff; }
th,td { border:1px solid #ddd; padding:6px; text-align:center; }
th { background:#f2f2f2; }
.status { text-align:center; margin:6px; color:#666; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>

<h2>Available Dresses</h2>

<div class="search-container">
  <input id="searchModel" placeholder="Model">
  <input id="searchColor" placeholder="Color">
  <input id="searchSize" placeholder="Size">
  <button onclick="generateInventory()">جرد</button>
</div>

<div class="status" id="statusMsg"></div>

<table>
<thead>
<tr>
  <th>Model</th>
  <th>Color</th>
  <th>Size</th>
  <th>Count</th>
</tr>
</thead>
<tbody id="dressesTable">
<tr><td colspan="4">Loading...</td></tr>
</tbody>
</table>

<!-- صندوق النسخ المضمون -->
<textarea id="copyBox" style="position:fixed;left:-9999px;"></textarea>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey:"AIzaSyBDVd2SHAmtIbJGlH0lrnPSz-eHfsg6Gyc",
  databaseURL:"https://show-inventory-default-rtdb.europe-west1.firebasedatabase.app"
});
const db=firebase.database();

/* قواعد */
const doubleModels=["simple","back less","sewar","koko","hand"];
const sizeMinusOneModels=["funika","shabarat"];

const sizeToDoubleIndex={
  38:1,40:1,
  42:2,44:2,
  46:3,48:3,
  50:4,
  52:5
};

const doubleSizeRule={
  1:"وزن 44–50",
  2:"وزن 51–63",
  3:"وزن 64–76",
  4:"وزن 77–90",
  5:"وزن 96–115"
};

const sizeToWeight={
  38:"وزن 44–50",
  40:"وزن 44–50",
  42:"وزن 51–57",
  44:"وزن 58–63",
  46:"وزن 64–70",
  48:"وزن 71–76",
  50:"وزن 77–82",
  52:"وزن 83–90"
};

const colorMap={
  black:"أسود",white:"أبيض",red:"أحمر",pink:"زهري",
  blue:"أزرق","baby blue":"أزرق","dark blue":"كحلي","royale blue":"أزرق نيلي",
  green:"أخضر",purple:"بنفسجي",yellow:"أصفر",
  beige:"بيج",brown:"بني",grey:"رمادي",smok:"رمادي",burghandi:"خمري",
  "black & white":"أبيض وأسود","white & black":"أبيض وأسود",
  "black&white":"أبيض وأسود","white&black":"أبيض وأسود"
};

/* عناصر */
const tableBody=document.getElementById("dressesTable");
const searchModel=document.getElementById("searchModel");
const searchColor=document.getElementById("searchColor");
const searchSize=document.getElementById("searchSize");
const copyBox=document.getElementById("copyBox");

let allDresses=[];

/* تحميل البيانات */
db.ref("/dresses").on("value",snap=>{
  const data=snap.val()||{};
  allDresses=[];
  for(const k in data){
    if((data[k].status||"").toLowerCase()==="in_stock"){
      allDresses.push(data[k]);
    }
  }
  renderTable();
});

/* عرض الجدول */
function renderTable(){
  const mf=searchModel.value.toLowerCase();
  const cf=searchColor.value.toLowerCase();
  const sf=searchSize.value.toLowerCase();
  const grouped={};

  allDresses.filter(d=>
    d.model.toLowerCase().includes(mf) &&
    d.color.toLowerCase().includes(cf) &&
    d.size.toString().includes(sf)
  ).forEach(d=>{
    const k=`${d.model}_${d.color}_${d.size}`;
    if(!grouped[k]) grouped[k]={...d,count:0};
    grouped[k].count++;
  });

  const rows=Object.values(grouped);

  rows.sort((a,b)=>{
    if(a.model.toLowerCase()<b.model.toLowerCase()) return -1;
    if(a.model.toLowerCase()>b.model.toLowerCase()) return 1;
    return parseInt(a.size)-parseInt(b.size);
  });

  if(!rows.length){
    tableBody.innerHTML=`<tr><td colspan="4">No results</td></tr>`;
    return;
  }

  tableBody.innerHTML=rows.map(d=>`
    <tr>
      <td>${d.model}</td>
      <td>${d.color}</td>
      <td>${d.size}</td>
      <td>${d.count}</td>
    </tr>
  `).join("");
}

/* الجرد */
function generateInventory(){
  const rows=[...tableBody.querySelectorAll("tr")];
  if(!rows.length) return alert("ابحث عن موديل واحد");

  const modelRaw=rows[0].children[0].innerText;
  const model=modelRaw.toLowerCase();
  const isDouble=doubleModels.includes(model);

  let out=`==== ${modelRaw} ====\n\n`;
  const byColor={};

  rows.forEach(r=>{
    let size=parseInt(r.children[2].innerText);
    const count=parseInt(r.children[3].innerText);
    if(!count) return;

    if(sizeMinusOneModels.includes(model)) size-=2;
    if(size<38) return;

    let weight;
    if(isDouble){
      const idx=sizeToDoubleIndex[size];
      weight=doubleSizeRule[idx];
    } else {
      weight=sizeToWeight[size];
    }
    if(!weight) return;

    const color=colorMap[r.children[1].innerText.toLowerCase()]||r.children[1].innerText;
    if(!byColor[color]) byColor[color]={};
    byColor[color][weight]=(byColor[color][weight]||0)+count;
  });

  Object.keys(byColor).forEach(c=>{
    out+=`${c}:\n`;
    Object.keys(byColor[c]).forEach(w=>{
      out+=`${w} عدد ${byColor[c][w]}\n`;
    });
    out+="\n";
  });

  copyBox.value=out.trim();
  copyBox.select();
  document.execCommand("copy");
  alert("تم نسخ الجرد ✔");
}

/* أحداث */
[searchModel,searchColor,searchSize].forEach(i=>i.addEventListener("input",renderTable));
</script>

</body>
</html>
