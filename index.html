<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>Available Dresses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body { font-family: Arial, sans-serif; padding: 10px; background: #f9f9f9; font-size: 12px; }
    h2 { color: #333; text-align: center; margin-top: 0; font-size: 16px; }
    .search-container {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; margin-bottom: 10px;
    }
    .search-container input {
      padding: 4px; width: 90px; font-size: 11px;
      border: 1px solid #ccc; border-radius: 4px; outline: none;
    }
    button { padding: 4px 10px; font-size: 11px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; background: #fff; font-size: 11px; }
    th, td { border: 1px solid #e5e5e5; padding: 6px; text-align: center; }
    th { background-color: #f2f2f2; }
    tr:hover { background-color: #fafafa; }
    .status { margin: 6px auto; text-align: center; color: #666; font-size: 11px; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>

<h2>Available Dresses</h2>

<div class="search-container">
  <input type="text" id="searchModel" placeholder="Model" />
  <input type="text" id="searchColor" placeholder="Color" />
  <input type="text" id="searchSize"  placeholder="Size" />
  <button onclick="generateInventory()">جَــرد</button>
</div>

<div class="status" id="statusMsg"></div>

<table>
  <thead>
    <tr>
      <th>Model</th>
      <th>Color</th>
      <th>Size</th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody id="dressesTable">
    <tr><td colspan="4">Loading...</td></tr>
  </tbody>
</table>

<script>
/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBDVd2SHAmtIbJGlH0lrnPSz-eHfsg6Gyc",
  authDomain: "show-inventory.firebaseapp.com",
  databaseURL: "https://show-inventory-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "show-inventory",
  storageBucket: "show-inventory.firebasestorage.app",
  messagingSenderId: "697364304883",
  appId: "1:697364304883:web:e559c3e444497e3b533886"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= ثوابت ================= */

// موديلات مزدوجة
const doubleModels = ["simple","back less","sewar","koko","hand"];

// قواعد الموديلات المزدوجة (ثابتة)
const doubleSizeRule = {
  1: "وزن 44–50",
  2: "وزن 51–63",
  3: "وزن 64–76",
  4: "وزن 77–90",
  5: "وزن 96–115"
};

// الجدول الأم – كل الموديلات العادية
const sizeToWeight = {
  38: "وزن 44–50",
  40: "وزن 44–50",
  42: "وزن 51–57",
  44: "وزن 58–63",
  46: "وزن 64–70",
  48: "وزن 71–76",
  50: "وزن 77–82",
  52: "وزن 83–90"
};

// موديلات صغيرة مقاس (ننزلهم نمرة وحدة فقط)
const sizeMinusOneModels = ["funika","shabarat"];

// الألوان بالعربي
const colorMap = {
  black:"أسود", white:"أبيض", red:"أحمر", pink:"زهري",
  blue:"أزرق", "baby blue":"أزرق", "dark blue":"كحلي", "royale blue":"أزرق نيلي",
  green:"أخضر", purple:"بنفسجي", yellow:"أصفر",
  beige:"بيج", brown:"بني", grey:"رمادي", smok:"رمادي", burghandi:"خمري",
  "black & white":"أبيض وأسود","white & black":"أبيض وأسود",
  "black&white":"أبيض وأسود","white&black":"أبيض وأسود"
};

/* ================= Elements ================= */
const tableBody = document.getElementById("dressesTable");
const searchModel = document.getElementById("searchModel");
const searchColor = document.getElementById("searchColor");
const searchSize  = document.getElementById("searchSize");
const statusMsg   = document.getElementById("statusMsg");

let allDresses = [];

/* ================= Helpers ================= */
function setLoading(msg="Loading..."){
  tableBody.innerHTML = `<tr><td colspan="4">${msg}</td></tr>`;
}
function setStatus(msg=""){ statusMsg.textContent = msg; }

// نسخ مضمون 100%
function copyText(text){
  const ta = document.createElement("textarea");
  ta.value = text;
  document.body.appendChild(ta);
  ta.select();
  document.execCommand("copy");
  document.body.removeChild(ta);
}

/* ================= Fetch ================= */
function fetchDresses(){
  setLoading();
  setStatus("Fetching data…");

  db.ref("/dresses").on("value", snap=>{
    const data = snap.val() || {};
    allDresses = [];

    for(const k in data){
      const d = data[k];
      if((d.status||"").toLowerCase()==="in_stock"){
        allDresses.push({
          model:d.model||"",
          color:d.color||"",
          size:d.size||""
        });
      }
    }
    setStatus("Updated.");
    renderTable();
  });
}

/* ================= Render Table ================= */
function renderTable(){
  const mf=searchModel.value.toLowerCase();
  const cf=searchColor.value.toLowerCase();
  const sf=searchSize.value.toLowerCase();

  const grouped={};

  allDresses
    .filter(d=>d.model.toLowerCase().includes(mf)
      && d.color.toLowerCase().includes(cf)
      && d.size.toLowerCase().includes(sf))
    .forEach(d=>{
      const k=`${d.model}__${d.color}__${d.size}`;
      if(!grouped[k]) grouped[k]={...d,count:0};
      grouped[k].count++;
    });

  const rows=Object.values(grouped);
  if(!rows.length){ setLoading("No results"); return; }

  rows.sort((a,b)=>{
    if(a.model.toLowerCase()<b.model.toLowerCase()) return -1;
    if(a.model.toLowerCase()>b.model.toLowerCase()) return 1;
    return parseInt(a.size)-parseInt(b.size);
  });

  tableBody.innerHTML = rows.map(d=>`
    <tr>
      <td>${d.model}</td>
      <td>${d.color}</td>
      <td>${d.size}</td>
      <td>${d.count}</td>
    </tr>`).join("");
}

/* ================= الجرد (وزن فقط) ================= */
function generateInventory(){
  const rows=[...tableBody.querySelectorAll("tr")];
  if(!rows.length) return alert("اعمل بحث عن موديل واحد");

  const modelNameRaw=rows[0].children[0].innerText;
  const modelName=modelNameRaw.toLowerCase();
  const isDouble = doubleModels.includes(modelName);

  let out=`==== ${modelNameRaw} ====\n\n`;
  const byColor={};

  rows.forEach(r=>{
    const colorEn=r.children[1].innerText.toLowerCase().trim();
    let sizeKey=parseInt(r.children[2].innerText);
    const count=Number(r.children[3].innerText);
    if(!count) return;

    // تنزيل نمرة وحدة فقط لـ Funika و Shabarat
    if(sizeMinusOneModels.includes(modelName)){
      sizeKey = sizeKey - 2;
    }

    if(sizeKey < 38) return;

    const colorAr=colorMap[colorEn]||colorEn;
    const weight = isDouble
      ? doubleSizeRule[sizeKey]
      : sizeToWeight[sizeKey];

    if(!weight) return;

    if(!byColor[colorAr]) byColor[colorAr]={};
    if(!byColor[colorAr][weight]) byColor[colorAr][weight]=0;
    byColor[colorAr][weight]+=count;
  });

  Object.keys(byColor).forEach(color=>{
    out+=`${color}:\n`;
    Object.keys(byColor[color]).forEach(w=>{
      out+=`${w} عدد ${byColor[color][w]}\n`;
    });
    out+="\n";
  });

  copyText(out.trim());
  alert("تم نسخ الجرد ✔");
}

/* ================= Init ================= */
[searchModel,searchColor,searchSize]
  .forEach(i=>i.addEventListener("input",renderTable));

fetchDresses();
</script>

</body>
</html>
