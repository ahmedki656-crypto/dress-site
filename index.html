import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getFirestore,
  collection,
  query,
  where,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBDVd2SHAmtIbJGlH0lrnPSz-eHfsg6Gyc",
  authDomain: "show-inventory.firebaseapp.com",
  projectId: "show-inventory",
  storageBucket: "show-inventory.appspot.com",
  messagingSenderId: "697364304883",
  appId: "1:697364304883:web:a7b41cc929228976533886",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let dressList = [];

function subscribeDressesRealtime() {
  const container = document.getElementById("dresses-container");
  container.classList.remove("error");
  container.classList.add("loading");
  container.textContent = "Loading dresses...";

  const dressesCol = collection(db, "dresses");
  const q = query(dressesCol, where("status", "==", "in_stock"));

  onSnapshot(q, (snapshot) => {
    if (snapshot.empty) {
      container.textContent = "No dresses found in stock.";
      container.classList.remove("loading");
      dressList = [];
      displayDresses(dressList);
      return;
    }

    dressList = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    container.classList.remove("loading");
    displayDresses(dressList);
  }, (error) => {
    container.textContent = "Error loading dresses: " + error.message;
    container.classList.add("error");
    container.classList.remove("loading");
    console.error("Firestore realtime error:", error);
  });
}

function displayDresses(list) {
  const container = document.getElementById("dresses-container");
  container.innerHTML = "";

  if (list.length === 0) {
    container.textContent = "No dresses found matching your search.";
    return;
  }

  list.forEach(dress => {
    const div = document.createElement("div");
    div.className = "dress-item";
    div.innerHTML = `
      <div><span class="label">Model:</span> ${dress.model}</div>
      <div><span class="label">Color:</span> ${dress.color}</div>
      <div><span class="label">Size:</span> ${dress.size}</div>
      <div><span class="label">Barcode:</span> ${dress.id}</div>
    `;
    container.appendChild(div);
  });
}

document.getElementById("searchBox").addEventListener("input", (e) => {
  const queryText = e.target.value.trim().toLowerCase();

  if (!queryText) {
    displayDresses(dressList);
    return;
  }

  const filtered = dressList.filter(dress =>
    (dress.model && dress.model.toLowerCase().includes(queryText)) ||
    (dress.color && dress.color.toLowerCase().includes(queryText)) ||
    (dress.size && dress.size.toLowerCase().includes(queryText))
  );

  displayDresses(filtered);
});

window.onload = () => {
  subscribeDressesRealtime();
};
